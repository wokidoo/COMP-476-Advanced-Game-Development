[gd_resource type="CompositorEffect" script_class="PostProcessShader" format=3 uid="uid://bfomuj3umgfsj"]

[ext_resource type="Script" uid="uid://0dpcvcr45bog" path="res://post_processing_compositor/post_process_shader.gd" id="1_h541y"]
[ext_resource type="Script" uid="uid://kdyeh5ru7mwf" path="res://post_processing_compositor/shader_slider.gd" id="2_8lq2j"]

[sub_resource type="Resource" id="Resource_nhccy"]
resource_name = "pixel_size"
script = ExtResource("2_8lq2j")
label = "pixel_size"
value = 2.0
metadata/_custom_type_script = "uid://kdyeh5ru7mwf"

[sub_resource type="Resource" id="Resource_a1vac"]
resource_name = "distance_factor"
script = ExtResource("2_8lq2j")
label = "distance_factor"
metadata/_custom_type_script = "uid://kdyeh5ru7mwf"

[resource]
resource_local_to_scene = false
resource_name = ""
enabled = false
effect_callback_type = 4
needs_motion_vectors = true
needs_normal_roughness = true
script = ExtResource("1_h541y")
sliders = Array[ExtResource("2_8lq2j")]([SubResource("Resource_nhccy"), SubResource("Resource_a1vac")])
shader_code = "float depth = texture(depth_texture,SCREEN_UV).x;
 
// Base pixel size from slider 0 (how strong the pixelation is overall)
float base_pixel_size = max(params.user_slider_0, 1.0);

// Min factor for distant objects
float min_factor = clamp(params.user_slider_1, 0.0, 1.0);
float d = clamp(depth, 0.0, 1.0);

// Compute depth-scaled block size
float block_size = base_pixel_size * mix(1.0, min_factor, d);
block_size = max(block_size, 1.0);

vec2 block = floor(FRAGCOORD / block_size) * block_size + vec2(block_size * 0.5);

// Sample from that block position
ivec2 sample_uv = ivec2(block);

// Clamp to viewport to be safe
sample_uv.x = clamp(sample_uv.x, 0, int(VIEWPORT_SIZE.x) - 1);
sample_uv.y = clamp(sample_uv.y, 0, int(VIEWPORT_SIZE.y) - 1);

vec4 src = imageLoad(color_image, sample_uv);
color = src;"
metadata/_custom_type_script = "uid://0dpcvcr45bog"
